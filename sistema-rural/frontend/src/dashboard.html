<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema Rural</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <a href="/">Sistema Rural</a>
            </div>
            <nav class="nav">
                <a href="/" class="nav-link">Home</a>
            </nav>
            <div class="auth-section">
                <div class="user-menu" id="userMenu">
                    <button class="user-avatar" id="userAvatar">
                        <span id="userInitial">U</span>
                    </button>
                    <div class="dropdown" id="userDropdown">
                        <a href="dashboard.html" class="dropdown-item active">
                            <span class="icon">üìä</span> Dashboard
                        </a>
                        <a href="mapeamento.html" class="dropdown-item">
                            <span class="icon">üó∫Ô∏è</span> Mapeamento
                        </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item logout-btn" id="logoutBtn">
                            <span class="icon">üö™</span> Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main dashboard-main">
        <div class="container">
            <!-- Dashboard Header -->
            <section class="dashboard-header">
                <h1>Dashboard</h1>
                <p>Vis√£o geral do seu sistema de propriedades rurais</p>
            </section>

            <!-- Quick Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üè°</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalProperties">0</div>
                        <div class="stat-label">Propriedades</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìê</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalArea">0</div>
                        <div class="stat-label">Hectares</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìè</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalPerimeter">0</div>
                        <div class="stat-label">Km Per√≠metro</div>
                    </div>
                </div>
            </section>

            <!-- Properties Management -->
            <section class="properties-management">
                <div class="card">
                    <div class="card-header">
                        <div class="section-header">
                            <div>
                                <h2>Gerenciar Propriedades</h2>
                                <p class="section-subtitle">Selecione propriedades para incluir no relat√≥rio</p>
                            </div>
                            <div class="selection-controls">
                                <button class="btn btn-outline btn-small" id="selectAllBtn">
                                    ‚úÖ Selecionar Todas
                                </button>
                                <button class="btn btn-outline btn-small" id="clearSelectionBtn">
                                    ‚ùå Limpar Sele√ß√£o
                                </button>
                                <a href="mapeamento.html" class="btn btn-outline btn-small">Ver no Mapa</a>
                                <button class="btn btn-secondary btn-small" id="importCsvBtn">
                                    üìÅ Importar CSV
                                </button>
                                <button class="btn btn-primary btn-small" id="generateReportBtn" disabled>
                                    üìÑ Gerar Relat√≥rio
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="properties-list" id="propertiesList">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Carregando propriedades...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>



            <!-- System Info -->
            <section class="system-info">
                <div class="card">
                    <div class="card-header">
                        <h2>Informa√ß√µes do Sistema</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Vers√£o:</span>
                                <span class="info-value">1.2.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">√öltimo Acesso:</span>
                                <span class="info-value" id="lastAccess">Carregando...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status:</span>
                                <span class="info-value status-online">üü¢ Online</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Tecnologia:</span>
                                <span class="info-value">AWS Lambda + ReportLab + PDF</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal de Importa√ß√£o CSV -->
    <div class="modal-overlay hidden" id="csvImportModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Importar Propriedades via CSV</h3>
                <button class="modal-close" id="csvModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Upload Section -->
                <div id="csvUploadSection">
                    <div class="csv-upload-area">
                        <div class="upload-icon">üìÅ</div>
                        <h4>Selecione o arquivo CSV</h4>
                        <p>Formatos aceitos: .csv (m√°ximo 5MB)</p>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
                            Escolher Arquivo
                        </button>
                    </div>
                    <div class="csv-format-info">
                        <h5>Formato esperado do CSV:</h5>
                        <code>nome,tipo,descricao,area,perimetro,coordenadas</code>
                        <p><small>Coordenadas devem estar em formato JSON: [[lng,lat],[lng,lat],...]</small></p>
                    </div>
                </div>

                <!-- Preview Section -->
                <div id="csvPreviewSection" class="hidden">
                    <h4>Preview dos dados (primeiras 5 linhas)</h4>
                    <div id="csvPreviewTable"></div>
                    <div id="csvStats" class="csv-stats"></div>
                    <div class="csv-actions">
                        <button class="btn btn-primary" id="confirmImportBtn">
                            ‚úÖ Confirmar Importa√ß√£o
                        </button>
                        <button class="btn btn-secondary" id="cancelImportBtn">
                            Cancelar
                        </button>
                    </div>
                </div>

                <!-- Status Section -->
                <div id="csvImportStatus" class="hidden">
                    <div class="import-progress">
                        <div class="loading-spinner"></div>
                        <p id="importStatusText">Processando importa√ß√£o...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal (necess√°rio para components.js) -->
    <div class="modal-overlay hidden" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Sistema</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Modal placeholder - n√£o deveria aparecer no dashboard</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/components.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Enhanced Dashboard Controller with Server-side PDF Report Generation
        class Dashboard {
            constructor() {
                this.properties = [];
                this.selectedProperties = new Set();
                this.apiBaseUrl = this.getApiUrl();
                this.websocketUrl = this.getWebSocketUrl();
                this.init();
            }

            getApiUrl() {
                if (window.SISTEMA_RURAL_CONFIG) {
                    return window.SISTEMA_RURAL_CONFIG.API_BASE_URL;
                }
                // Fallback para desenvolvimento
                return 'https://nfvbev7jgc.execute-api.us-east-1.amazonaws.com/devops';
            }

            getWebSocketUrl() {
                if (window.SISTEMA_RURAL_CONFIG) {
                    return window.SISTEMA_RURAL_CONFIG.WEBSOCKET_URL;
                }
                // Fallback para desenvolvimento
                return 'wss://5lsoua3trg.execute-api.us-east-1.amazonaws.com/devops';
            }

            init() {
                if (!auth.isAuthenticated() || !auth.isTokenValid()) {
                    window.location.href = '/';
                    return;
                }
                
                this.updateUserAvatar();
                this.loadDashboardData();
                this.updateLastAccess();
                this.bindEvents();
                this.initWebSocket();
            }

            bindEvents() {
                // Selection controls
                document.getElementById('selectAllBtn').addEventListener('click', () => this.selectAll());
                document.getElementById('clearSelectionBtn').addEventListener('click', () => this.clearSelection());
                
                // Report generation
                document.getElementById('generateReportBtn').addEventListener('click', () => this.generateReport());
                
                // CSV Import
                document.getElementById('importCsvBtn').addEventListener('click', () => this.openCsvModal());
                document.getElementById('csvFileInput').addEventListener('change', (e) => this.handleCsvFile(e));
                document.getElementById('confirmImportBtn').addEventListener('click', () => this.importCsvData());
                document.getElementById('cancelImportBtn').addEventListener('click', () => this.resetCsvModal());
                document.getElementById('csvModalClose').addEventListener('click', () => this.closeCsvModal());
                
                // Property list events will be bound when properties are rendered
            }

            updateUserAvatar() {
                if (window.userMenu) {
                    const userInfo = auth.getUserInfo();
                    if (userInfo) {
                        window.userMenu.updateUser(userInfo);
                    }
                } else {
                    setTimeout(() => this.updateUserAvatar(), 200);
                }
            }

            async loadDashboardData() {
                try {
                    await this.loadProperties();
                    this.updateStats();
                    this.renderPropertiesList();
                } catch (error) {
                    this.showDemoData();
                }
            }

            async loadProperties() {
                const token = auth.getToken();
                if (!token) throw new Error('No auth token');

                try {
                    const response = await fetch(`${this.apiBaseUrl}/properties`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.properties = data.properties || [];
                    } else {
                        this.properties = [];
                    }
                } catch (error) {
                    this.showDemoData();
                }
            }

            updateStats() {
                const totalProperties = this.properties.length;
                const totalArea = this.properties.reduce((sum, p) => sum + (p.area || 0), 0);
                const totalPerimeter = this.properties.reduce((sum, p) => sum + (p.perimeter || 0), 0);
                const selectedCount = this.selectedProperties.size;

                document.getElementById('totalProperties').textContent = totalProperties;
                document.getElementById('totalArea').textContent = totalArea.toFixed(1);
                document.getElementById('totalPerimeter').textContent = (totalPerimeter / 1000).toFixed(1);

                // Enable/disable report button
                const reportBtn = document.getElementById('generateReportBtn');
                reportBtn.disabled = selectedCount === 0;
                reportBtn.textContent = selectedCount > 0 ? 
                    `üìÑ Gerar Relat√≥rio (${selectedCount})` : 'üìÑ Gerar Relat√≥rio';
            }

            renderPropertiesList() {
                const container = document.getElementById('propertiesList');
                if (!container) return;
                
                if (this.properties.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üó∫Ô∏è</div>
                            <h3>Nenhuma propriedade cadastrada</h3>
                            <p>Comece criando sua primeira propriedade no mapeamento</p>
                            <a href="mapeamento.html" class="btn btn-primary">Criar Propriedade</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.properties.map(prop => `
                    <div class="property-item" data-property-id="${prop.id}">
                        <div class="property-selection">
                            <label class="checkbox-container">
                                <input type="checkbox" 
                                       class="property-checkbox" 
                                       data-property-id="${prop.id}"
                                       ${this.selectedProperties.has(prop.id) ? 'checked' : ''}>
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="property-content">
                            <div class="property-header">
                                <h4>${prop.name}</h4>
                                <span class="property-type">${this.capitalizeFirst(prop.type)}</span>
                                ${this.getAnalysisStatusBadge(prop.analysisStatus)}
                            </div>
                            <div class="property-metrics">
                                <span>üìê ${prop.area} ha</span>
                                <span>üìè ${(prop.perimeter / 1000).toFixed(1)} km</span>
                            </div>
                            <div class="property-date">
                                Criado em ${new Date(prop.createdAt).toLocaleDateString('pt-BR')}
                            </div>
                            ${prop.analysisStatus === 'completed' ? `
                                <div class="analysis-preview">
                                    <button class="btn btn-small btn-outline" onclick="window.dashboard.viewAnalysis('${prop.id}')">
                                        üìä Ver An√°lise
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="property-actions">
                            <button class="btn btn-small btn-outline" onclick="window.open('mapeamento.html', '_blank')">
                                üó∫Ô∏è Ver no Mapa
                            </button>
                        </div>
                    </div>
                `).join('');

                // Bind checkbox events
                container.querySelectorAll('.property-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        this.togglePropertySelection(e.target.dataset.propertyId, e.target.checked);
                    });
                });
            }

            getAnalysisStatusBadge(status) {
                const badges = {
                    'pending': '<span class="analysis-badge pending">‚è≥ An√°lise pendente</span>',
                    'processing': '<span class="analysis-badge processing">üîÑ Processando</span>',
                    'completed': '<span class="analysis-badge completed">‚úÖ An√°lise conclu√≠da</span>',
                    'error': '<span class="analysis-badge error">‚ùå Erro na an√°lise</span>'
                };
                return badges[status] || '';
            }

            async viewAnalysis(propertyId) {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/properties/${propertyId}/analysis`, {
                        headers: { 'Authorization': `Bearer ${auth.getToken()}` }
                    });

                    if (response.ok) {
                        const analysisData = await response.json();
                        this.showAnalysisModal(analysisData);
                    } else {
                        if (window.toast) {
                            window.toast.show('Erro ao carregar an√°lise', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Erro ao buscar an√°lise:', error);
                    if (window.toast) {
                        window.toast.show('Erro ao buscar an√°lise', 'error');
                    }
                }
            }

            showAnalysisModal(analysisData) {
                const property = this.properties.find(p => p.id === analysisData.propertyId);
                if (!property) return;

                const analysis = analysisData.analysis;
                
                // Create modal content
                const modalContent = `
                    <div class="analysis-modal-content">
                        <h3>An√°lise Geoespacial - ${property.name}</h3>
                        
                        ${analysis.analysisResults ? `
                            <div class="analysis-results">
                                ${analysis.analysisResults.elevation ? `
                                    <div class="analysis-section">
                                        <h4>üèîÔ∏è Eleva√ß√£o</h4>
                                        <div class="analysis-metrics">
                                            <span>M√©dia: ${analysis.analysisResults.elevation.avg_elevation}m</span>
                                            <span>M√°xima: ${analysis.analysisResults.elevation.max_elevation}m</span>
                                            <span>M√≠nima: ${analysis.analysisResults.elevation.min_elevation}m</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${analysis.analysisResults.ndvi ? `
                                    <div class="analysis-section">
                                        <h4>üå± Vegeta√ß√£o (NDVI)</h4>
                                        <div class="analysis-metrics">
                                            <span>NDVI m√©dio: ${analysis.analysisResults.ndvi.avg_ndvi}</span>
                                            <span>Cobertura: ${analysis.analysisResults.ndvi.vegetation_coverage}%</span>
                                            <span>Classifica√ß√£o: ${analysis.analysisResults.ndvi.classification}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${analysis.analysisResults.slope ? `
                                    <div class="analysis-section">
                                        <h4>üìê Declividade</h4>
                                        <div class="analysis-metrics">
                                            <span>Inclina√ß√£o m√©dia: ${analysis.analysisResults.slope.avg_slope}¬∞</span>
                                            <span>M√°xima: ${analysis.analysisResults.slope.max_slope}¬∞</span>
                                            <span>Classifica√ß√£o: ${analysis.analysisResults.slope.slope_classification}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${analysis.analysisResults.weather ? `
                                    <div class="analysis-section">
                                        <h4>üå§Ô∏è Clima</h4>
                                        <div class="analysis-metrics">
                                            <span>Chuva anual: ${analysis.analysisResults.weather.annual_rainfall}mm</span>
                                            <span>Temperatura: ${analysis.analysisResults.weather.avg_temperature}¬∞C</span>
                                            <span>Zona clim√°tica: ${analysis.analysisResults.weather.climate_zone}</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="analysis-footer">
                                    <small>An√°lise conclu√≠da em: ${new Date(analysis.completedAt).toLocaleDateString('pt-BR')}</small>
                                </div>
                            </div>
                        ` : '<p>Dados de an√°lise n√£o dispon√≠veis</p>'}
                    </div>
                `;

                // Show modal (reuse existing modal)
                const modal = document.getElementById('loginModal');
                modal.querySelector('#modalTitle').textContent = 'An√°lise Geoespacial';
                modal.querySelector('.modal-body').innerHTML = modalContent;
                modal.classList.remove('hidden');
            }

            togglePropertySelection(propertyId, selected) {
                if (selected) {
                    this.selectedProperties.add(propertyId);
                } else {
                    this.selectedProperties.delete(propertyId);
                }
                
                this.updateStats();
            }

            selectAll() {
                this.properties.forEach(prop => {
                    this.selectedProperties.add(prop.id);
                });
                
                // Update checkboxes
                document.querySelectorAll('.property-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                this.updateStats();
            }

            clearSelection() {
                this.selectedProperties.clear();
                
                // Update checkboxes
                document.querySelectorAll('.property-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                this.updateStats();
            }

            async generateReport() {
                const selectedProps = this.properties.filter(p => this.selectedProperties.has(p.id));
                
                if (selectedProps.length === 0) {
                    if (window.toast) {
                        window.toast.show('Selecione pelo menos uma propriedade', 'warning');
                    }
                    return;
                }

                const reportBtn = document.getElementById('generateReportBtn');
                reportBtn.disabled = true;
                reportBtn.textContent = '‚è≥ Gerando relat√≥rio...';

                try {
                    const propertyIds = selectedProps.map(p => p.id);
                    
                    const response = await fetch(`${this.apiBaseUrl}/properties/report`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${auth.getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            propertyIds: propertyIds
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    
                    this.downloadPDF(result.pdf, result.filename);
                    
                    if (window.toast) {
                        window.toast.show(`Relat√≥rio PDF gerado: ${result.filename}`, 'success');
                    }
                    
                } catch (error) {
                    console.error('Erro ao gerar relat√≥rio:', error);
                    if (window.toast) {
                        window.toast.show(`Erro ao gerar relat√≥rio: ${error.message}`, 'error');
                    }
                } finally {
                    reportBtn.disabled = false;
                    const selectedCount = this.selectedProperties.size;
                    reportBtn.textContent = selectedCount > 0 ? 
                        `üìÑ Gerar Relat√≥rio (${selectedCount})` : 'üìÑ Gerar Relat√≥rio';
                }
            }

            // Fun√ß√£o auxiliar para download do PDF
            downloadPDF(pdfBase64, filename) {
                try {
                    // Converter base64 para blob
                    const byteCharacters = atob(pdfBase64);
                    const byteNumbers = new Array(byteCharacters.length);
                    
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    
                    // Criar link de download
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Limpar URL object
                    window.URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Erro ao fazer download do PDF:', error);
                    if (window.toast) {
                        window.toast.show('Erro ao fazer download do arquivo', 'error');
                    }
                }
            }

            updateLastAccess() {
                const now = new Date();
                const formatted = now.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const lastAccessEl = document.getElementById('lastAccess');
                if (lastAccessEl) {
                    lastAccessEl.textContent = formatted;
                }
            }

            capitalizeFirst(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            // ========== CSV IMPORT FUNCTIONALITY ==========
            
            openCsvModal() {
                document.getElementById('csvImportModal').classList.remove('hidden');
                this.resetCsvModal();
            }

            closeCsvModal() {
                document.getElementById('csvImportModal').classList.add('hidden');
                this.resetCsvModal();
            }

            resetCsvModal() {
                document.getElementById('csvUploadSection').classList.remove('hidden');
                document.getElementById('csvPreviewSection').classList.add('hidden');
                document.getElementById('csvImportStatus').classList.add('hidden');
                document.getElementById('csvFileInput').value = '';
                this.csvData = null;
            }

            handleCsvFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    if (window.toast) {
                        window.toast.show('Por favor, selecione um arquivo CSV v√°lido', 'error');
                    }
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB
                    if (window.toast) {
                        window.toast.show('Arquivo muito grande. M√°ximo 5MB', 'error');
                    }
                    return;
                }

                // Read and parse CSV
                const reader = new FileReader();
                reader.onload = (e) => this.parseCsvContent(e.target.result);
                reader.readAsText(file);
            }

            parseCsvContent(csvContent) {
                try {
                    const lines = csvContent.trim().split('\n');
                    if (lines.length < 2) {
                        throw new Error('CSV deve ter pelo menos um cabe√ßalho e uma linha de dados');
                    }

                    // Parse header
                    const header = lines[0].split(',').map(h => h.trim().toLowerCase());
                    
                    // Validate required columns
                    const requiredColumns = ['nome', 'tipo', 'area', 'perimetro', 'coordenadas'];
                    const missingColumns = requiredColumns.filter(col => !header.includes(col));
                    
                    if (missingColumns.length > 0) {
                        throw new Error(`Colunas obrigat√≥rias ausentes: ${missingColumns.join(', ')}`);
                    }

                    // Parse data rows
                    const data = [];
                    const errors = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        try {
                            const values = this.parseCsvLine(line);
                            if (values.length !== header.length) {
                                errors.push(`Linha ${i + 1}: N√∫mero incorreto de colunas`);
                                continue;
                            }

                            const rowData = {};
                            header.forEach((col, index) => {
                                rowData[col] = values[index];
                            });

                            // Validate and convert data
                            const property = this.validateCsvRow(rowData, i + 1);
                            if (property.valid) {
                                data.push(property.data);
                            } else {
                                errors.push(`Linha ${i + 1}: ${property.error}`);
                            }
                        } catch (e) {
                            errors.push(`Linha ${i + 1}: ${e.message}`);
                        }
                    }

                    if (data.length === 0) {
                        throw new Error('Nenhum dado v√°lido encontrado no CSV');
                    }

                    // Show preview
                    this.csvData = data;
                    this.showCsvPreview(data, errors);

                } catch (error) {
                    if (window.toast) {
                        window.toast.show(`Erro ao processar CSV: ${error.message}`, 'error');
                    }
                }
            }

            parseCsvLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                values.push(current.trim());
                return values;
            }

            validateCsvRow(row, lineNumber) {
                try {
                    // Required fields
                    const nome = row.nome?.trim();
                    if (!nome || nome.length < 2) {
                        return { valid: false, error: 'Nome inv√°lido' };
                    }

                    const tipo = row.tipo?.trim().toLowerCase() || 'fazenda';
                    const validTypes = ['fazenda', 'sitio', 'chacara', 'terreno', 'outros'];
                    if (!validTypes.includes(tipo)) {
                        return { valid: false, error: `Tipo inv√°lido: ${tipo}` };
                    }

                    const area = parseFloat(row.area);
                    if (isNaN(area) || area <= 0) {
                        return { valid: false, error: '√Årea inv√°lida' };
                    }

                    const perimetro = parseFloat(row.perimetro);
                    if (isNaN(perimetro) || perimetro <= 0) {
                        return { valid: false, error: 'Per√≠metro inv√°lido' };
                    }

                    // Parse coordinates
                    let coordinates;
                    try {
                        coordinates = JSON.parse(row.coordenadas);
                        if (!Array.isArray(coordinates) || coordinates.length < 4) {
                            throw new Error('Coordenadas insuficientes');
                        }
                    } catch (e) {
                        return { valid: false, error: 'Coordenadas em formato inv√°lido (deve ser JSON)' };
                    }

                    return {
                        valid: true,
                        data: {
                            name: nome,
                            type: tipo,
                            description: row.descricao?.trim() || '',
                            area: area,
                            perimeter: perimetro,
                            coordinates: coordinates
                        }
                    };

                } catch (error) {
                    return { valid: false, error: error.message };
                }
            }

            showCsvPreview(data, errors) {
                document.getElementById('csvUploadSection').classList.add('hidden');
                document.getElementById('csvPreviewSection').classList.remove('hidden');

                // Create preview table
                const preview = data.slice(0, 5);
                let tableHtml = `
                    <table class="csv-preview-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>√Årea (ha)</th>
                                <th>Per√≠metro (m)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                preview.forEach(prop => {
                    tableHtml += `
                        <tr>
                            <td>${prop.name}</td>
                            <td>${this.capitalizeFirst(prop.type)}</td>
                            <td>${prop.area.toFixed(2)}</td>
                            <td>${prop.perimeter.toFixed(0)}</td>
                            <td><span class="status-valid">‚úÖ V√°lido</span></td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table>';
                document.getElementById('csvPreviewTable').innerHTML = tableHtml;

                // Show stats
                const statsHtml = `
                    <div class="csv-stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">Total de propriedades:</span>
                            <span class="stat-value">${data.length}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Erros encontrados:</span>
                            <span class="stat-value ${errors.length > 0 ? 'error' : ''}">${errors.length}</span>
                        </div>
                        ${data.length > 5 ? `
                        <div class="stat-item">
                            <span class="stat-label">Mostrando:</span>
                            <span class="stat-value">5 de ${data.length}</span>
                        </div>` : ''}
                    </div>
                `;

                document.getElementById('csvStats').innerHTML = statsHtml;

                // Show errors if any
                if (errors.length > 0) {
                    const errorHtml = `
                        <div class="csv-errors">
                            <h5>‚ö†Ô∏è Linhas com erro (ser√£o ignoradas):</h5>
                            <ul>${errors.slice(0, 10).map(err => `<li>${err}</li>`).join('')}</ul>
                            ${errors.length > 10 ? `<p><small>...e mais ${errors.length - 10} erros</small></p>` : ''}
                        </div>
                    `;
                    document.getElementById('csvStats').innerHTML += errorHtml;
                }
            }

            async importCsvData() {
                if (!this.csvData || this.csvData.length === 0) {
                    if (window.toast) {
                        window.toast.show('Nenhum dado v√°lido para importar', 'error');
                    }
                    return;
                }

                document.getElementById('csvPreviewSection').classList.add('hidden');
                document.getElementById('csvImportStatus').classList.remove('hidden');

                const statusText = document.getElementById('importStatusText');
                const confirmBtn = document.getElementById('confirmImportBtn');
                
                confirmBtn.disabled = true;

                try {
                    statusText.textContent = `Importando ${this.csvData.length} propriedades...`;

                    const response = await fetch(`${this.apiBaseUrl}/properties/import`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${auth.getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            properties: this.csvData
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    
                    statusText.textContent = '‚úÖ Importa√ß√£o conclu√≠da com sucesso!';
                    
                    if (window.toast) {
                        window.toast.show(`${result.imported} propriedades importadas com sucesso!`, 'success');
                    }

                    setTimeout(() => {
                        this.loadDashboardData();
                        this.closeCsvModal();
                    }, 2000);

                } catch (error) {
                    console.error('Erro na importa√ß√£o:', error);
                    statusText.textContent = '‚ùå Erro na importa√ß√£o';
                    
                    if (window.toast) {
                        window.toast.show(`Erro na importa√ß√£o: ${error.message}`, 'error');
                    }

                    setTimeout(() => {
                        document.getElementById('csvImportStatus').classList.add('hidden');
                        document.getElementById('csvPreviewSection').classList.remove('hidden');
                    }, 3000);
                } finally {
                    confirmBtn.disabled = false;
                }
            }
            
            async initWebSocket() {
                const token = auth.getToken();
                
                this.ws = new WebSocket(`${this.websocketUrl}?token=${token}`);
                
                this.ws.onopen = () => {
                    console.log('WebSocket conectado');
                    this.ws.send(JSON.stringify({
                        action: 'subscribe',
                        topic: 'analysis.completed'
                    }));
                };
                
                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleWebSocketMessage(message);
                };
            }

            handleWebSocketMessage(message) {
                if (message.type === 'analysis_notification' && message.event === 'completed') {
                    const propertyIndex = this.properties.findIndex(p => p.id === message.propertyId);
                    if (propertyIndex !== -1) {
                        this.properties[propertyIndex].analysisStatus = 'completed';
                        this.renderPropertiesList();
                    }
                    
                    window.toast.show(message.message, 'success');
                }
            }
        
        
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new Dashboard();
            
            // Direct logout handler
            document.addEventListener('click', (e) => {
                if (e.target.closest('#logoutBtn') || e.target.closest('.logout-btn')) {
                    e.preventDefault();
                    auth.signOut();
                }
            });
        });
    </script>

    <style>
        /* CSV Import Modal Styles */
        .csv-upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius-lg);
            padding: var(--space-3xl);
            text-align: center;
            background: var(--gray-50);
            transition: var(--transition);
            margin-bottom: var(--space-lg);
        }

        .csv-upload-area:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.6;
        }

        .csv-format-info {
            background: var(--gray-100);
            padding: var(--space-lg);
            border-radius: var(--border-radius);
            margin-top: var(--space-lg);
        }

        .csv-format-info h5 {
            margin-bottom: var(--space-sm);
            color: var(--gray-700);
        }

        .csv-format-info code {
            background: white;
            padding: var(--space-sm);
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            display: block;
            margin-bottom: var(--space-sm);
        }

        .csv-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-lg);
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .csv-preview-table th,
        .csv-preview-table td {
            padding: var(--space-sm);
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.9rem;
        }

        .csv-preview-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .csv-preview-table tr:hover {
            background: var(--gray-50);
        }

        .status-valid {
            color: var(--success);
            font-weight: 500;
        }

        .csv-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .csv-stats-grid .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--gray-50);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--primary);
        }

        .csv-stats-grid .stat-label {
            font-weight: 500;
            color: var(--gray-600);
        }

        .csv-stats-grid .stat-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .csv-stats-grid .stat-value.error {
            color: var(--error);
        }

        .csv-errors {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--border-radius);
            padding: var(--space-lg);
            margin-top: var(--space-lg);
        }

        .csv-errors h5 {
            color: var(--error);
            margin-bottom: var(--space-md);
        }

        .csv-errors ul {
            list-style: none;
            padding: 0;
        }

        .csv-errors li {
            padding: var(--space-xs) 0;
            color: var(--error);
            font-size: 0.9rem;
        }

        .csv-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: center;
            margin-top: var(--space-lg);
        }

        .import-progress {
            text-align: center;
            padding: var(--space-3xl);
        }

        .import-progress p {
            margin-top: var(--space-lg);
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Modal size adjustment for CSV */
        #csvImportModal .modal {
            max-width: 600px;
            width: 95%;
        }

        @media (max-width: 768px) {
            .csv-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .csv-actions {
                flex-direction: column;
            }
            
            .csv-preview-table {
                font-size: 0.8rem;
            }
            
            .csv-preview-table th,
            .csv-preview-table td {
                padding: var(--space-xs);
            }
        }

        /* Analysis Status Badges */
        .analysis-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: var(--space-sm);
        }

        .analysis-badge.pending {
            background: rgba(251, 191, 36, 0.1);
            color: #d97706;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .analysis-badge.processing {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .analysis-badge.completed {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .analysis-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Analysis Modal */
        .analysis-modal-content h3 {
            color: var(--primary);
            margin-bottom: var(--space-lg);
        }

        .analysis-section {
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--primary);
        }

        .analysis-section h4 {
            margin-bottom: var(--space-md);
            color: var(--gray-800);
            font-size: 1rem;
        }

        .analysis-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .analysis-metrics span {
            background: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            border: 1px solid var(--gray-200);
        }

        .analysis-footer {
            margin-top: var(--space-lg);
            padding-top: var(--space-md);
            border-top: 1px solid var(--gray-200);
            text-align: center;
            color: var(--gray-500);
        }

        @media (max-width: 768px) {
            .analysis-metrics {
                flex-direction: column;
                gap: var(--space-sm);
            }
        }
    </style>
</body>
</html>